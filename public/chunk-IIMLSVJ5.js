import{a as t}from"./chunk-DVA2SMLH.js";import{m as g}from"./chunk-VX3KMHVW.js";import{N as d,S as m}from"./chunk-353TJUNG.js";import{h as o}from"./chunk-FK42CRUA.js";var f=class u{constructor(r){this.router=r}sesionIniciada=!1;login(r,e){return o(this,null,function*(){try{let{data:a,error:s}=yield t.auth.signInWithPassword({email:r,password:e});return{data:a,error:s}}catch(a){return console.error("Login error:",a),{data:null,error:a instanceof Error?a:new Error("Unknown error")}}})}logout(){return o(this,null,function*(){let{error:r}=yield t.auth.signOut();return r||(this.sesionIniciada=!1),{error:r}})}getSession(){return o(this,null,function*(){let{data:{session:r}}=yield t.auth.getSession();return this.sesionIniciada=!!r,{session:r}})}register(r,e,a,s){return o(this,null,function*(){if(!e)return console.error("La contrase\xF1a es requerida"),{error:{message:"La contrase\xF1a es requerida"}};try{let{data:n,error:l}=yield t.auth.signUp({email:r,password:e,options:{data:{username:a}}});if(l)return{error:l};let c=null;if(s){let i=yield this.saveFile(s);if(i){let{data:{publicUrl:h}}=yield t.storage.from("images").getPublicUrl(i.path);c=h}}if(n.user){let{error:i}=yield t.from("usuarios").insert([{name:a,email:r,avatar_url:c}]);if(i)return{error:i}}return this.router.navigate(["/home"]),{data:n}}catch(n){return console.error("Error inesperado en registro:",n),{error:n}}})}saveFile(r){return o(this,null,function*(){let e=`users/${Date.now()}_${r.name}`,{data:a,error:s}=yield t.storage.from("images").upload(e,r,{cacheControl:"3600",upsert:!1});return s?(console.error("Error subiendo archivo:",s.message),null):a})}getUserDataByMail(r){return o(this,null,function*(){try{let{data:e,error:a}=yield t.from("usuarios").select("*").eq("email",r).single();if(a)throw a;return{data:e||null,error:null}}catch(e){return{data:null,error:e instanceof Error?e:new Error("Error desconocido")}}})}getUserProfile(){return o(this,null,function*(){try{let{data:{user:r},error:e}=yield t.auth.getUser();if(e)throw e;if(!r)throw new Error("No hay usuario logueado");let{data:a}=yield this.getUserDataByMail(r.email);return{authId:a?.authId||"0",name:a?.name||r.email||"Usuario",email:a?.email||r.email||"",avatarUrl:a?.avatar_url||"assets/images/default-profile.png"}}catch(r){return console.error("Error cargando datos:",r),{authId:-1,name:"Error cargando datos",email:"",avatarUrl:"assets/images/default-profile.png"}}})}getCurrentUser(){return t.auth.getUser()}static \u0275fac=function(e){return new(e||u)(m(g))};static \u0275prov=d({token:u,factory:u.\u0275fac,providedIn:"root"})};export{f as a};
